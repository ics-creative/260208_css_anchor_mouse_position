<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSS Anchor Positioning Mouse Stalker</title>
    <style>
      :root {
        /* Demo全体で使うトークン */
        --bg-start: #f6f4ff;
        --bg-end: #e6e2ff;
        --accent: #3223b0;
        --stalker-size: 44.8px;
        --snap-gap: 1px;
        --anim-duration: 0.2s;
      }

      body {
        margin: 0;
        min-height: 100svh;
        font-family: sans-serif;
        background:
          radial-gradient(circle at 8% 15%, #ffffffcc 0 15%, transparent 45%),
          radial-gradient(circle at 95% 85%, #ffffffaa 0 12%, transparent 45%),
          linear-gradient(145deg, var(--bg-start), var(--bg-end));
        display: grid;
        place-items: center;

        .card {
          width: min(672px, 100vw - 32px);
          border: 1px solid color-mix(in oklab, var(--accent) 24%, white 76%);
          border-radius: 20px;
          background: #ffffffcc;
          box-shadow: 0 24px 48px
            color-mix(in oklab, var(--accent) 20%, transparent);

          .demo {
            min-height: 240px;
            padding: 20px;
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
            @media (width < 720px) {
                flex-direction: column;
            }

            .demo-button {
              appearance: none;
              border: 2px solid var(--accent);
              border-radius: 999px;
              background: #fff;
              color: var(--accent);
              font: inherit;
              font-weight: bold;
              padding: 12px 24px;
              cursor: pointer;
              transition: var(--anim-duration);

              &:hover {
                background: var(--accent);
                color: #fff;
              }
            }

            #btn-a {
              /* pointerenter時にこのanchorへ吸着 */
              anchor-name: --button-anchor-a;
            }

            #btn-b {
              /* pointerenter時にこのanchorへ吸着 */
              anchor-name: --button-anchor-b;
            }

            #btn-c {
              /* pointerenter時にこのanchorへ吸着 */
              anchor-name: --button-anchor-c;
            }
          }
        }
      }

      .stalker {
        /* 通常時はマウス位置へ追従するリング */
        position: fixed;
        pointer-events: none;
        left: var(--mouse-x);
        top: var(--mouse-y);
        translate: -50% -50%;
        width: var(--stalker-size);
        height: var(--stalker-size);
        border-radius: 999px;
        border: 2px solid var(--accent);
        transition: var(--anim-duration);

        &.is-snapped {
          /* 吸着時はanchorの中心へ移動し、対象要素サイズに合わせて拡大 */
          transition: var(--anim-duration);
          left: anchor(center);
          top: anchor(center);
          width: calc(anchor-size(width) + (var(--snap-gap) * 4));
          height: calc(anchor-size(height) + (var(--snap-gap) * 4));
          border-radius: 999px;
        }
      }
    </style>
  </head>
  <body>

    <div class="stalker"></div>

    <main class="card">
      <section class="demo">
        <button
          class="demo-button"
          id="btn-a"
          data-anchor="--button-anchor-a"
        >
          A
        </button>
        <button
          class="demo-button"
          id="btn-b"
          data-anchor="--button-anchor-b"
        >
          B
        </button>
        <button
          class="demo-button"
          id="btn-c"
          data-anchor="--button-anchor-c"
        >
          C
        </button>
      </section>
    </main>


    <script>
      const root = document.documentElement;
      const stalker = document.querySelector(".stalker");
      const buttons = document.querySelectorAll(".demo-button");
      // currentは描画中座標、targetは最新ポインタ座標
      const follow = {
        currentX: window.innerWidth / 2,
        currentY: window.innerHeight / 2,
        targetX: window.innerWidth / 2,
        targetY: window.innerHeight / 2,
      };

      const setMouseVars = (x, y) => {
        root.style.setProperty("--mouse-x", `${Math.round(x)}px`);
        root.style.setProperty("--mouse-y", `${Math.round(y)}px`);
      };

      setMouseVars(follow.currentX, follow.currentY);

      const moveAnchor = (event) => {
        // coalesced events が取れる場合は末尾（最新点）を採用
        const coalesced = event.getCoalescedEvents?.();
        const point =
          coalesced && coalesced.length > 0
            ? coalesced[coalesced.length - 1]
            : event;
        follow.targetX = point.clientX;
        follow.targetY = point.clientY;
      };

      const snapToButton = (anchorName) => {
        stalker.style.positionAnchor = anchorName;
        stalker.classList.add("is-snapped");
      };

      const releaseFromButton = () => {
        stalker.style.positionAnchor = "none";
        stalker.classList.remove("is-snapped");
      };

      const tickFollow = () => {
        // 追従を補間して急なポインタ移動でも滑らかに見せる
        follow.currentX += (follow.targetX - follow.currentX) * 0.5;
        follow.currentY += (follow.targetY - follow.currentY) * 0.5;
        setMouseVars(follow.currentX, follow.currentY);

        requestAnimationFrame(tickFollow);
      };

      requestAnimationFrame(tickFollow);

      buttons.forEach((button) => {
        const anchorName = button.dataset.anchor;

        button.addEventListener("pointerenter", () => snapToButton(anchorName));
        button.addEventListener("pointerleave", releaseFromButton);
      });

      window.addEventListener("pointermove", moveAnchor, { passive: true });
    </script>
  </body>
</html>
